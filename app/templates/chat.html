{% extends "base.html" %}

{% block title %}AI Assistant - StudyHub{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">AI Study Assistant</h1>

    <!-- Chat Interface -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
        <!-- Chat Header -->
        <div class="bg-gradient-to-r from-primary to-secondary text-white p-4">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="font-semibold">StudyBot</h3>
                    <p class="text-sm opacity-90">Your AI-powered study companion</p>
                </div>
                <div class="ml-auto">
                    <span class="text-sm bg-green-500 px-2 py-1 rounded-full">Online</span>
                </div>
            </div>
        </div>

        <!-- Chat Messages -->
        <div id="chat-messages" class="h-96 overflow-y-auto p-4 space-y-4">
            <!-- Messages will be added here -->
        </div>

        <!-- Chat Input -->
        <div class="border-t bg-gray-50 p-4">
            <form id="chat-form" class="flex gap-3">
                <input type="text" id="chat-input" placeholder="Ask me anything about your studies..." required
                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                <button type="submit" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold">
                    Send
                </button>
            </form>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">Quick Questions</h2>
        <div class="grid md:grid-cols-2 gap-4">
            <button class="quick-question text-left p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
                    data-question="How can I improve my study habits?">
                <div class="font-semibold text-gray-800">Study Techniques</div>
                <div class="text-sm text-gray-600">How can I improve my study habits?</div>
            </button>
            <button class="quick-question text-left p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
                    data-question="What's the best way to manage time for multiple assignments?">
                <div class="font-semibold text-gray-800">Time Management</div>
                <div class="text-sm text-gray-600">Managing multiple assignments</div>
            </button>
            <button class="quick-question text-left p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
                    data-question="How do I stay motivated when studying gets difficult?">
                <div class="font-semibold text-gray-800">Motivation</div>
                <div class="text-sm text-gray-600">Staying motivated during tough times</div>
            </button>
            <button class="quick-question text-left p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
                    data-question="What are effective note-taking strategies?">
                <div class="font-semibold text-gray-800">Note-Taking</div>
                <div class="text-sm text-gray-600">Effective note-taking strategies</div>
            </button>
        </div>
    </div>

    <!-- Chat Features -->
    <div class="grid md:grid-cols-2 gap-6">
        <!-- Chat History -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4">Recent Conversations</h3>
            <div id="chat-history" class="space-y-3">
                <div class="text-gray-500 text-center py-8">
                    Start a conversation to see your chat history here.
                </div>
            </div>
        </div>

        <!-- AI Capabilities -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4">What I Can Help With</h3>
            <div class="space-y-3">
                <div class="flex items-start">
                    <div class="w-2 h-2 bg-green-500 rounded-full mt-2 mr-3"></div>
                    <div>
                        <div class="font-medium">Study Strategies</div>
                        <div class="text-sm text-gray-600">Personalized study techniques and methods</div>
                    </div>
                </div>
                <div class="flex items-start">
                    <div class="w-2 h-2 bg-blue-500 rounded-full mt-2 mr-3"></div>
                    <div>
                        <div class="font-medium">Subject Help</div>
                        <div class="text-sm text-gray-600">Questions about math, science, history, and more</div>
                    </div>
                </div>
                <div class="flex items-start">
                    <div class="w-2 h-2 bg-purple-500 rounded-full mt-2 mr-3"></div>
                    <div>
                        <div class="font-medium">Time Management</div>
                        <div class="text-sm text-gray-600">Planning and organizing your academic schedule</div>
                    </div>
                </div>
                <div class="flex items-start">
                    <div class="w-2 h-2 bg-yellow-500 rounded-full mt-2 mr-3"></div>
                    <div>
                        <div class="font-medium">Motivation & Wellness</div>
                        <div class="text-sm text-gray-600">Staying motivated and managing stress</div>
                    </div>
                </div>
                <div class="flex items-start">
                    <div class="w-2 h-2 bg-red-500 rounded-full mt-2 mr-3"></div>
                    <div>
                        <div class="font-medium">Assignment Help</div>
                        <div class="text-sm text-gray-600">Breaking down complex assignments</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Typing Indicator -->
<div id="typing-indicator" class="hidden">
    <div class="flex items-center space-x-1">
        <div class="loading-spinner w-2 h-2 bg-gray-400 rounded-full"></div>
        <div class="loading-spinner w-2 h-2 bg-gray-400 rounded-full" style="animation-delay: 0.1s"></div>
        <div class="loading-spinner w-2 h-2 bg-gray-400 rounded-full" style="animation-delay: 0.2s"></div>
        <span class="text-sm text-gray-500 ml-2">StudyBot is typing...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let chatHistory = [];

    document.addEventListener('DOMContentLoaded', function() {
        // Load chat history from server
        loadChatHistory();

        // Quick question buttons
        document.querySelectorAll('.quick-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const question = btn.getAttribute('data-question');
                document.getElementById('chat-input').value = question;
                sendMessage(question);
            });
        });

        // Check chat status
        checkChatStatus();

        // Add welcome message
        addMessage("Hello! I'm StudyBot, your AI study assistant powered by GEMINI. I'm here to help you with studying, time management, motivation, and any academic questions you might have. How can I assist you today?", false);
    });

    function addMessage(message, isUser = false) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageElement = document.createElement('div');
        messageElement.className = `chat-message mb-4 ${isUser ? 'text-right' : 'text-left'}`;

        const messageContent = document.createElement('div');
        messageContent.className = `inline-block max-w-xs lg:max-w-md px-4 py-3 rounded-lg ${
            isUser
                ? 'bg-primary text-white rounded-br-none'
                : 'bg-gray-100 text-gray-800 rounded-bl-none shadow'
        }`;

        // Handle longer messages by wrapping text properly
        messageContent.style.whiteSpace = 'pre-wrap';
        messageContent.textContent = message;

        messageElement.appendChild(messageContent);
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Save to history if it's a user message
        if (isUser) {
            const conversation = {
                id: Date.now(),
                question: message,
                timestamp: new Date().toLocaleString(),
                preview: message.length > 50 ? message.substring(0, 50) + '...' : message
            };
            chatHistory.unshift(conversation);
            chatHistory = chatHistory.slice(0, 10); // Keep only last 10 conversations
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            renderChatHistory();
        }
    }

    async function sendMessage(message) {
        try {
            // Show user message immediately
            addMessage(message, true);

            // Show typing indicator
            showTypingIndicator();

            // Send request to backend
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();

            // Hide typing indicator
            hideTypingIndicator();

            if (response.ok) {
                // Add AI response
                addMessage(data.response, false);
            } else {
                // Handle error
                addMessage(data.error || 'Sorry, I encountered an error. Please try again.', false);
            }

        } catch (error) {
            hideTypingIndicator();
            addMessage('Sorry, I\'m having trouble connecting right now. Please check your internet connection and try again.', false);
            console.error('Chat error:', error);
        }
    }

    async function loadChatHistory() {
        try {
            const response = await fetch('/api/chat/history');
            const data = await response.json();

            if (response.ok && data.history) {
                chatHistory = data.history;
                renderChatHistory();
            }
        } catch (error) {
            console.error('Failed to load chat history:', error);
        }
    }

    async function checkChatStatus() {
        try {
            const response = await fetch('/api/chat/status');
            const data = await response.json();

            if (response.ok) {
                if (!data.gemini_configured) {
                    addMessage('⚠️ GEMINI AI is not configured. Please set your API key in the .env file for full functionality.', false);
                }
            }
        } catch (error) {
            console.error('Failed to check chat status:', error);
        }
    }

    function showTypingIndicator() {
        const messagesContainer = document.getElementById('chat-messages');
        const typingElement = document.createElement('div');
        typingElement.id = 'typing-message';
        typingElement.className = 'chat-message mb-4 text-left';
        typingElement.innerHTML = `
            <div class="inline-block bg-gray-100 px-4 py-3 rounded-lg rounded-bl-none shadow">
                <div class="flex items-center space-x-1">
                    <div class="loading-spinner w-2 h-2 bg-gray-400 rounded-full"></div>
                    <div class="loading-spinner w-2 h-2 bg-gray-400 rounded-full" style="animation-delay: 0.1s"></div>
                    <div class="loading-spinner w-2 h-2 bg-gray-400 rounded-full" style="animation-delay: 0.2s"></div>
                    <span class="text-sm text-gray-500 ml-2">StudyBot is typing...</span>
                </div>
            </div>
        `;
        messagesContainer.appendChild(typingElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function hideTypingIndicator() {
        const typingElement = document.getElementById('typing-message');
        if (typingElement) {
            typingElement.remove();
        }
    }

    function renderChatHistory() {
        const container = document.getElementById('chat-history');

        if (chatHistory.length === 0) {
            container.innerHTML = '<div class="text-gray-500 text-center py-8">Start a conversation to see your chat history here.</div>';
            return;
        }

        container.innerHTML = chatHistory.map(chat => `
            <div class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors"
                 onclick="reloadConversation('${chat.question}')">
                <div class="font-medium text-sm text-gray-800">${chat.preview}</div>
                <div class="text-xs text-gray-500 mt-1">${chat.timestamp}</div>
            </div>
        `).join('');
    }

    function reloadConversation(question) {
        document.getElementById('chat-input').value = question;
        document.getElementById('chat-input').focus();
    }

    // Chat form submission
    document.getElementById('chat-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const chatInput = document.getElementById('chat-input');
        if (chatInput && chatInput.value.trim()) {
            const message = chatInput.value.trim();
            chatInput.value = '';
            await sendMessage(message);
        }
    });

    // Make reloadConversation global
    window.reloadConversation = reloadConversation;
</script>
{% endblock %}